


{{define "styles"}}

        <style>
.form_inputs {
	display: flex;
	justify-content: space-between;
	flex-direction: column;
	row-gap: 20px;
	margin-top: 20px;
}

.form_field_section {
	display: flex;
	flex-direction: column;
	row-gap: 5px;
}

.form_field_container {
	display: flex;
	flex-direction: row;
	align-items: center;
	column-gap: 10px;
	width: 100%;
}

.item_field_container {
	display: flex;
	justify-content: space-between;
	border: solid 1px #CCC;
	border-radius: 10px;
	min-height: 30px;
	padding: 10px;
	width: calc(100% - 180px);
}

.item_field_label {
	color: #000;
	font-family: var(--primary-font);
	font-size: 14px;
	font-style: normal;
	font-weight: 400;
	line-height: 110%;
	margin-bottom: 6px;
	width: 150px;
}

.button_container {
	width: 250px;
	align-self: flex-end;
}

/* actions CSS starts here */
.item_form_container.success .success_message {
	display: block;
}

button[disabled] {
	opacity: 0.5;
	pointer-events: none;
}

/* actions CSS ends here */
        </style>
{{end}}

{{define "body"}}
    <body class="body">
            {{template "sidebar" .}}

            <main class="main">
            	{{template "header" .}}

		<section class="item_form_container" id="item_form_container">
			<p class="success_message" id="success_message" ></p>
			<p class="error_message" id="error_message"></p>
			<form class="item_form" id="item_form">
				<div class="form_inputs">
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_name">Name</label>
							<span class="item_field_container">
								<input class="text_field" id="video_name" name="name" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_thumb_url">Thumb URL</label>
							<span class="item_field_container">
								<input class="text_field" id="video_thumb_url" name="thumb_url" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_image_url">Image URL</label>
							<span class="item_field_container">
								<input class="text_field" id="video_image_url" name="image_url" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_video_url">Video URL</label>
							<span class="item_field_container">
								<input class="text_field" id="video_video_url" name="video_url" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_subtitles_url">Subtitles URL</label>
							<span class="item_field_container">
								<input class="text_field" id="video_subtitles_url" name="subtitles_url" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_description">Description</label>
							<span class="item_field_container">
								<input class="text_field" id="video_description" name="description" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_release_date">Release Date</label>
							<span class="item_field_container">
								<input class="text_field" id="video_release_date" name="release_date" type="date" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_width">Width</label>
							<span class="item_field_container">
								<input class="text_field" id="video_width" name="width" type="number" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_height">Height</label>
							<span class="item_field_container">
								<input class="text_field" id="video_height" name="height" type="number" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_duration">Duration</label>
							<span class="item_field_container">
								<input class="text_field" id="video_duration" name="duration" type="number" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_sequence">Sequence</label>
							<span class="item_field_container">
								<input class="text_field" id="video_sequence" name="sequence" type="number" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_file">File</label>
							<span class="item_field_container">
								<input class="text_field" id="video_file" name="file" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_original_file">Original File</label>
							<span class="item_field_container">
								<input class="text_field" id="video_original_file" name="original_file" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_path">Path</label>
							<span class="item_field_container">
								<input class="text_field" id="video_path" name="path" />
							</span>
						</div>
					</div>
					<div class="form_field_section">
						<span class="error_message"></span>
						<div class="form_field_container">

							<label class="item_field_label" for="video_md5sum">Md5sum</label>
							<span class="item_field_container">
								<input class="text_field" id="video_md5sum" name="md5sum" />
							</span>
						</div>
					</div>
					<span class="button_container">
						<button class="big_button" id="submit_button" type="submit">
							<span class="big_button_spacer"></span>
							<span class="big_button_text" id="submit_button_text">Save</span>
							<img class="big_button_arrow" src="static/img/chevron_forward_24dp_FILL0_wght400_GRAD0_opsz24.svg" alt="arrow right">
						</button>
					</span>
				</div>
			</form>
		</section>
        </main>
		<script>
const successMessageField = document.getElementById("success_message");
const errorMessageField = document.getElementById("error_message");
const itemForm = document.getElementById("item_form");
const itemFormContainer = document.getElementById("item_form_container");
const submitButton = document.getElementById("submit_button");
const fieldName = document.getElementById("video_name");
const fieldThumbURL = document.getElementById("video_thumb_url");
const fieldImageURL = document.getElementById("video_image_url");
const fieldVideoURL = document.getElementById("video_video_url");
const fieldSubtitlesURL = document.getElementById("video_subtitles_url");
const fieldDescription = document.getElementById("video_description");
const fieldReleaseDate = document.getElementById("video_release_date");
const fieldWidth = document.getElementById("video_width");
const fieldHeight = document.getElementById("video_height");
const fieldDuration = document.getElementById("video_duration");
const fieldSequence = document.getElementById("video_sequence");
const fieldFile = document.getElementById("video_file");
const fieldOriginalFile = document.getElementById("video_original_file");
const fieldPath = document.getElementById("video_path");
const fieldMd5sum = document.getElementById("video_md5sum");
fieldName.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldThumbURL.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldImageURL.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldVideoURL.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldSubtitlesURL.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldDescription.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldReleaseDate.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldWidth.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldHeight.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldDuration.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldSequence.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldFile.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldOriginalFile.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldPath.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});
fieldMd5sum.addEventListener("input", function () {
	itemFormContainer.classList.remove("success");

	this.closest(".form_field_section").querySelector(".error_message").innerHTML = "";
});

var currentVideo = 0;

const idQuery = new URLSearchParams(window.location.search).get("id");

if (parseInt(idQuery) > 0) {
	currentVideo = parseInt(idQuery);
}

if (authToken) {
	getVideo(currentVideo);
} else {
	gotoLogin();
}

itemForm.addEventListener("submit", function (event) {
	event.preventDefault();
	saveVideo();
});

async function getVideo(id) {
	const videosURL =
		`v1/videos/${id}`;

	if (id == 0) {
		return;
	}

	const response = await fetch(videosURL, {
		method: "GET",
		headers: getHeaders(),
	});

	if (response.status === 200) {
		const jsonData = await response.json();

		const itemData = jsonData.video;
		fieldName.value = itemData.name;
		fieldThumbURL.value = itemData.thumb_url;
		fieldImageURL.value = itemData.image_url;
		fieldVideoURL.value = itemData.video_url;
		fieldSubtitlesURL.value = itemData.subtitles_url;
		fieldDescription.value = itemData.description;
		fieldReleaseDate.value = itemData.release_date.slice(0, 16);
		fieldWidth.value = itemData.width;
		fieldHeight.value = itemData.height;
		fieldDuration.value = itemData.duration;
		fieldSequence.value = itemData.sequence;
		fieldFile.value = itemData.file;
		fieldOriginalFile.value = itemData.original_file;
		fieldPath.value = itemData.path;
		fieldMd5sum.value = itemData.md5sum;

	} else {
		gotoLogin();
	}
}

async function saveVideo() {
	submitButton.disabled = true;

	let url = "v1/videos";
	let method = "POST";

	if (currentVideo > 0) {
		url = "v1/videos/" + currentVideo;
		method = "PATCH";
	}

	const data = {
		name: fieldName.value,
		thumb_url: fieldThumbURL.value,
		image_url: fieldImageURL.value,
		video_url: fieldVideoURL.value,
		subtitles_url: fieldSubtitlesURL.value,
		description: fieldDescription.value,
		release_date: new Date(fieldReleaseDate.value).toISOString(),
		width: fieldWidth.value,
		height: fieldHeight.value,
		duration: fieldDuration.value,
		sequence: fieldSequence.value,
		file: fieldFile.value,
		original_file: fieldOriginalFile.value,
		path: fieldPath.value,
		md5sum: fieldMd5sum.value,
	};

	const response = await fetch(url, {
		method: method,
		headers: getHeaders(),
		body: JSON.stringify(data),
	});

	if (response.ok) {
		const serverResponse = await response.json();
		
		successMessageField.innerHTML = "Video saved successfully";

		history.pushState(null, "", "admin/video.html?id=" + serverResponse.video.id);

		currentVideo = serverResponse.video.id;

		itemFormContainer.classList.add("success");

		submitButton.disabled = false;
	} else {
		submitButton.disabled = false;

		const error = await response.json();

		if (typeof error.error === 'string') {
			let errorMessage = error.error;

			errorMessageField.innerHTML = errorMessage;
		} else {
			for (const [key, value] of Object.entries(error.error)) {
				let errorMessage = value;

				const errorField = document.querySelector(`input[name='${key}']`);
				if (errorField && errorField.closest('.field_section') && errorField.closest('.field_section').querySelector('.error_message')) {
					errorField.closest('.field_section').querySelector('.error_message').innerHTML = errorMessage;
				} else {
					errorMessageField.innerText = errorMessage;
				}
			}
		}
	}
}

		</script>
    </body>

{{end}}
